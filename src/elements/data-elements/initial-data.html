<!--import [polymer, etools-ajax, static-data-behavior, user-controller, user-data]-->

<dom-module id="initial-data">

    <template>

        <user-data user="{{user}}"></user-data>

        <!--tpm partners-->
        <etools-ajax endpoint="[[partnersEndpoint]]"
                     on-success="_partnersLoaded"
                     on-fail="_partnersError"></etools-ajax>

        <etools-ajax method="OPTIONS"
                     url="[[partnersOptionsUrl]]"
                     on-success="_handlePartnersOptions"
                     on-fail="_handlePartnersOptions"></etools-ajax>

        <etools-ajax method="OPTIONS"
                     url="[[visitsOptionsUrl]]"
                     on-success="_handleVisitsOptions"
                     on-fail="_handleVisitsOptions"></etools-ajax>

        <!--partner organisations-->
        <etools-ajax endpoint="[[organisationsEndpoint]]"
                     on-success="_organisationsLoaded"
                     on-fail="_organisationsError"></etools-ajax>

        <!--pp/sfa Outputs-->
        <etools-ajax url="[[outputsEndpoint]]"
                     on-success="_outputsLoaded"
                     on-fail="_outputsError"></etools-ajax>
    </template>

    <script>

        (function() {
            'use strict';

            let dataLoaded = {};

            Polymer({

                is: 'initial-data',
                behaviors: [
                    etoolsAppConfig.globals,
                    TPMBehaviors.UserController,
                    TPMBehaviors.StaticDataController,
                    TPMBehaviors.PermissionController
                ],

                listeners: {
                    'user-profile-loaded': 'loadStaticData'
                },

                loadStaticData: function () {
                    if (this.isTpmUser()) {
                        this.partnersEndpoint = this.getEndpoint('partnersList');
                    } else {
                        this.organisationsEndpoint = this.getEndpoint('partnerOrganisations');
                        this.partnersOptionsUrl = this.getEndpoint('partnersList').url;
                        this.outputsEndpoint = this.getEndpoint('ppSsfaOutputs').url;
                    }
                    this.visitsOptionsUrl = this.getEndpoint('visitsList').url;
                    this._allDataLoaded();
                },

                _allDataLoaded: function() {
                    let tpmUser = this.isTpmUser();
                    if (((dataLoaded.organizations && dataLoaded.partners && dataLoaded.outputs) || !tpmUser) &&
                            dataLoaded.visitsOptions &&
                            (dataLoaded.partnersOptions || tpmUser)) {
                        this.fire('initial-data-loaded');
                    }
                },

                _partnersLoaded: function(data, detail) {
                    let partnerId = detail && detail.results && detail.results[0] && detail.results[0].id;
                    this._setPartnerId(partnerId);
                    if(!partnerId) { console.error('Can not get TPM Partner id!'); }
                    dataLoaded.partners = true;
                    this._allDataLoaded();
                },

                _organisationsLoaded: function(data, detail) {
                    if (!detail) {
                        this._organisationsError();
                    }
                    this._setData('partnerOrganisations', detail);
                    dataLoaded.organizations = true;
                    this._allDataLoaded();
                },

                _outputsLoaded: function(data, detail) {
                    if (!detail) {
                        this._outputsError();
                    }
                    this._setData('ppSsfaOutputs', detail);
                    dataLoaded.outputs = true;
                    this._allDataLoaded();
                },

                _handleVisitsOptions: function(data, detail) {
                    let actions = detail && detail.actions;
                    if (!this.isValidCollection(actions)) {
                        this._responseError('visit options');
                        return;
                    }

                    this._addToCollection('new_visit', actions);

                    let statusesData = this.getChoices('new_visit.status');
                    let visitAttachmentsTypes = this.getChoices('new_visit.attachments.file_type');

                    if (!statusesData) { console.error('Can not load visit statuses data'); }
                    if (!visitAttachmentsTypes) { this._responseError('Can not load attachments types'); }

                    this._setData('statuses', statusesData);
                    this._setData('visit_attachments_types', visitAttachmentsTypes);

                    dataLoaded.visitsOptions = true;
                    this._allDataLoaded();
                },

                _handlePartnersOptions: function(data, detail) {
                    let actions = detail && detail.actions;
                    if (!this.isValidCollection(actions)) {
                        this._responseError('partners options');
                        return;
                    }

                    this._addToCollection('new_partner', actions);

                    let partnerAttachmentsTypes = this.getChoices('new_partner.attachments.file_type');
                    if (!partnerAttachmentsTypes) { this._responseError('Can not load attachments types'); }
                    this._setData('partner_attachments_types', partnerAttachmentsTypes);

                    dataLoaded.partnersOptions = true;
                    this._allDataLoaded();
                },

                _organisationsError: function() {
                    this._responseError('partner organisations');
                },

                _outputsError: function() {
                    this._responseError('ppSsfaOutputs');
                },

                _responseError: function(request) {
                    console.error(`Can not load initial data${request ? ': ' + request : ''}`);
                    this.fire('initial-data-loaded');
                }

            });

        })();

    </script>

</dom-module>
