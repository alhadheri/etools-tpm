<!--import [polymer, etools-ajax, lodash, permission-controller, static-data-behavior]-->

<dom-module id="user-data">

    <template>

        <etools-ajax endpoint="[[endpoint]]"
                     caching-storage="custom"
                     dexie-db-collection="profile"
                     on-success="_handleResponse"
                     on-fail="_handleError"></etools-ajax>
    </template>

    <script>

        Polymer({

            is: 'user-data',

            behaviors: [
                etoolsAppConfig.globals,
                TPMBehaviors.PermissionController,
                TPMBehaviors.StaticDataController,
            ],

            properties: {
                user: {
                    type: Object,
                    readOnly: true,
                    notify: true,
                    value: function() {
                        return {};
                    }
                }
            },

            ready: function () {
                this.endpoint = this.getEndpoint('userProfile');
            },

            _handleResponse: function (data) {
                let user = data.detail;
                let previousUserId = JSON.parse(localStorage.getItem('userId'));

                this._setUser(user);

                if (!previousUserId || previousUserId !== user.id) {
                    this.resetOldUserData();
                }

                localStorage.setItem('userId', user.id);

                this.addGroupsToStorage();

                this.fire('user-profile-loaded');
            },

            _handleError: function (rsp, err) {
                console.error('Can\'t load user data');
            },

            addGroupsToStorage: function() {
                if (!this.user || !this.user.groups) { return; }
                let groups = this.user.groups.map((group) => {
                    return group.name;
                });
                this._setData('userGroups', groups)
            }

        });

    </script>

</dom-module>
