<!--import [polymer, etools-ajax, query-params-controller]-->

<dom-module id="trips-list-data">

    <template>

        <etools-ajax
                endpoint="[[endpoint]]"
                caching-storage="custom"
                dexie-db-collection="trips"
                on-success="_tripsLoaded"
                on-fail="_responseError"></etools-ajax>

    </template>

    <script>

        Polymer({

            is: 'trips-list-data',
            behaviors: [
                etoolsAppConfig.globals,
                TPMBehaviors.QueryParamsController
            ],

            properties: {
                trips: {
                    type: Array,
                    value: [],
                    notify: true
                },
                tripsList: {
                    type: Array,
                    readOnly: true,
                    notify: true
                },
                requestQueries: {
                    type: Object,
                    observer: 'getTripsList'
                },
                listLength: {
                    type: Number,
                    notify: true,
                    computed: '_setListLength(trips)'
                }

            },

            ready: function () {
                this.endpoint = this.getEndpoint('tripsList');
            },

            _tripsLoaded: function(data) {
                this.trips = data.detail;
                if (this._validatePageQuery()) {
                    this.getTripsList();
                }
            },
            _responseError: function() {},

            getTripsList: function() {
                if (!this.trips.length) return;
                if (this.currentTransaction) {
                    this.currentTransaction.abort();
                }

                this.appDexieDb.transaction('r', this.appDexieDb.trips, () => {
                    this.currentTransaction = Dexie.currentTransaction;


                    let trips = this.appDexieDb.trips,
                            params = this.requestQueries || {};

                    if (params.ordered_by) {
                        let [field, order] = params.ordered_by.split('.');
                        trips = trips.orderBy(field);
                        if (order === 'desc') { trips = trips.reverse(); }
                    }
                    if (!this.withoutPagination && params.size) {
                        trips
                                .offset( ((params.page || 1) - 1) * params.size )
                                .limit(+params.size)
                    }



                    return trips.toArray();
                }).then((result) => {
                    this._setTripsList(result);
                });
            },

            _validatePageQuery: function() {
                if (!this.requestQueries) return;
                if (!this.requestQueries.page || !this.requestQueries.size) return true;
                let lastPage = this.trips.length % this.requestQueries.size ?
                        Math.floor(this.trips.length / this.requestQueries.size + 1) :
                this.trips.length / this.requestQueries.size;

                if (+this.requestQueries.page > lastPage) {
                    //update page query
                    this.updateQueries({page: `${lastPage}`})
                } else {
                    return true;
                }
            },

            _setListLength: function(trips) {
                return trips.length;
            }

        });

    </script>

</dom-module>
