<!--import [polymer, etools-ajax, lodash, permission-controller, etools-app-config]-->

<dom-module id="update-partner-details-data">

    <template>

        <etools-ajax method="{{method}}"
                     url="{{url}}"
                     body="{{postData}}"
                     on-success="_handleResponse"
                     on-fail="_handleError"></etools-ajax>

        <etools-ajax method="OPTIONS"
                     url="[[optionsUrl]]"
                     on-success="_handleOptionsResponse"
                     on-fail="_handleOptionsResponse"></etools-ajax>
    </template>

    <script>

        Polymer({

            is: 'update-partner-details-data',

            behaviors: [
                etoolsAppConfig.globals,
                TPMBehaviors.PermissionController
            ],

            properties: {
                newPartnerDetails: {
                    type: Object,
                    observer: '_detailsChanged'
                },
                partner: {
                    type: Object,
                    notify: true
                },
                errorObject: {
                    type: Object,
                    notify: true
                },
                basePermissionPath: {
                    type: String,
                    notify: true
                }
            },

            _handleResponse: function (event, details) {
                if (this.method === 'POST') {
                    this.lastData = details;
                    this._finishPostResponse(this.postRequest);
                    return;
                } else if (this.postRequest) {
                    this._detailsChanged(this.postRequest);
                    return;
                }
                this.finishResponse(details);
                this.fire('global-loading', {type: 'save-partner'});
            },

            _finishPostResponse: function(details) {
                this.fire('global-loading', {type: 'update-permissions', active: true, message: 'Updating data...'});
                this.fire('global-loading', {type: `${details.action}-partner`});

                this.optionsUrl = this.getEndpoint('partnerDetails', {id: details.id}).url;
                this.postRequest = null;
            },

            _handleOptionsResponse: function(event, details) {
                if (this.lastData && details && details.actions) {
                    let collectionName = `partner_${this.lastData.id}`;

                    this._updateCollection(collectionName, details.actions);
                    this.basePermissionPath = '';
                    this.basePermissionPath = collectionName;
                } else {
                    this.basePermissionPath = 'not_found';
                    this.fire('toast', {text: 'Can not update permissions data. Please reload the page!'});
                    console.error('Can not load permissions');
                }
                this.fire('global-loading', {type: 'update-permissions'});
                this.optionsUrl = '';
                this.finishResponse(this.lastData);
            },

            finishResponse: function(details) {
                if (details) {
                    this.set('partner', details);
                } else {
                    console.error('Can not update partner. Data is missing');
                }
                this.fire('partner-updated', {success: true});
                this.fire('toast', {text: `Partner has been updated!`});
            },

            _handleError: function (event, error) {
                let action = this.postRequest && this.postRequest.action || 'save';
                this.fire('global-loading', {type: `${action}-partner`});
                this.fire('partner-updated');

                let responseData = error && error.request && error.request.detail &&
                        error.request.detail.request && error.request.detail.request.xhr;

                let {status, response} = responseData || {};

                if (status === 400) {
                    this.set('errorObject', response);
                    this.fire('toast', {text: 'Can not save partner data. Please check all fields and try again later!'});
                } else {
                    this.errorObject = {};
                    this.fire('toast', {text: 'Can not update partner. Please try again later!'});
                }
            },

            _detailsChanged: function(details) {
                if (!details || !details.id || !details.method) { return; }
                let url = this.getEndpoint('partnerDetails', {id: details.id}).url;

                if (details.method === 'POST' && (this.postRequest || _.isEmpty(details.data))) {
                    this.fire('global-loading', {message: details.message, active: true, type: `${details.action}-partner`});
                    this.fire('global-loading', {type: 'save-partner'});
                    this.method = 'POST';
                    this.url = `${url}${details.action}/`;
                    this.postData = {};
                    this.postRequest = details;
                    return;
                } else if (details.method === 'POST' && !this.postRequest) {
                    this.postRequest = details;
                }
                this._startPatchRequest(url, details.data);
            },

            _startPatchRequest: function(url, data) {
                this.fire('global-loading', {message: 'Saving partner...', active: true, type: 'save-partner'});
                this.method = 'PATCH';
                this.postData = data || {};
                this.url = url;
            }

        });

    </script>

</dom-module>
