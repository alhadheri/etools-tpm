<!--import [polymer, etools-ajax, static-data-behavior, permission-controller, user-data]-->

<dom-module id="static-data">

    <template>

        <user-data user="{{user}}"></user-data>

        <!--partners-->
        <etools-ajax
                endpoint="[[partnersEndpoint]]"
                caching-storage="custom"
                dexie-db-collection="partner_organizations"
                on-success="_partnersLoaded"
                on-fail="_partnersError"></etools-ajax>

        <etools-ajax method="OPTIONS"
                     url="[[partnersOptionsUrl]]"
                     on-success="_handlePartnerOptions"
                     on-fail="_handlePartnerOptions"></etools-ajax>

    </template>

    <script>

        (function() {
            'use strict';

            let dataLoaded = {};

            Polymer({

                is: 'static-data',
                behaviors: [
                    etoolsAppConfig.globals,
                    TPMBehaviors.StaticDataController,
                    TPMBehaviors.PermissionController
                ],

                properties: {
                    user: {
                        type: Object,
                        notify: true
                    }
                },
                listeners: {
                    'user-profile-loaded': 'loadStaticData',
                },

                loadStaticData: function () {
                    let groups = this.getData('userGroups');
                    this.tpmUser = !!~groups.indexOf('Third Party Monitor');
                    if (this.tpmUser) {
                        this.partnersEndpoint = this.getEndpoint('partnerOrganisations');
                    }
                    this._allDataLoaded()
                },

                _allDataLoaded: function() {
                    if ((dataLoaded.partners || !this.tpmUser)) {
                        this.fire('static-data-loaded');
                    }
                },

                _partnersLoaded: function(data, detail) {
                    //TODO: !format of response detail may be changed later!
                    let partnerId = detail && detail[0] && detail[0].id;
                    this.user.partnerId = partnerId;
                    if(!partnerId) { console.error('Can not get TPM Partner id!'); }
                    dataLoaded.partners = true;
                    this._allDataLoaded();
                },

                _responseError: function() {
                    console.error('Can not load initial data');
                    this.fire('static-data-loaded');
                }

            });

        })();

    </script>

</dom-module>
